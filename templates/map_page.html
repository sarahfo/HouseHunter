{% extends 'base.html' %}
{% block content %}


<div class="container">
    <div class="row">
        <div class="col-md-9">
			<div id="map" style="width:100%; height:500px"></div>
        <div id="slider"></div>
<p>{{ city }}</p>
<p id="homes"></p>

<script>

$('#homes').text("{{listings|count}}" + " homes are for sale in {{city}}");

// <!-- {% for listing in listings %} -->

// <!--   {{listing.address}} {{listing.city}} {{listing.zip_code}} {{listing.list_price}}
//   Latitude: {{listing.latitude}} Longitude: {{listing.longitude}} -->
// {% endfor %}
// </ul>
$(function() {
    $( "#slider" ).slider();
  });

</script>
 
<script>
//MAKE MAP APPEAR

L.mapbox.accessToken = 'pk.eyJ1Ijoic2FyYWhmbyIsImEiOiJaQmdHLWZJIn0.eEg4zenYs0-qcPsMBZ9i1g';
var map = L.mapbox.map('map').setView([{{setView.lat}},{{setView.lon}}], 13);
L.control.layers({
	'Mapbox Streets': L.mapbox.tileLayer('mapbox.streets').addTo(map),
});

var myHouseLayer = L.mapbox.featureLayer().addTo(map)
var setView = [{{setView.lat}}, {{setView.lon}}]
var features = [];

// Using Jinja to unpack and create the feature collections for the feature layer:
{% for listing in listings %}
  {% if listing.latitude %}
  {% if listing.longitude %}

              features.push({
                  type: 'Feature',   //geoJSON portion
                  geometry: {
                      type: 'Point',
                      coordinates: [{{listing.longitude}}, {{listing.latitude}}]

                  },
                  properties: {
                      'marker-color': '#060',
                      'marker-symbol': 'building',
                       title: '{{listing.address, listing.zip_code, listing.longitude,listing.latitude}}',
                       'url': '{{listing.url}}'
                      {% if listing.list_price %}
                        'price': '{{listing.list_price}}'
                      {% endif %}
                      
                  }
              });
      {% endif %}
  {% endif %}      
{% endfor %}
          myHouseLayer.setGeoJSON({
              type: 'FeatureCollection',
              features: features
          });

          map.on('move', function() {
              // Construct an empty list to fill with onscreen markers.
              var inBounds = [],
              // Get the map bounds - the top-left and bottom-right locations.
                  bounds = map.getBounds();

              // For each marker, consider whether it is currently visible by comparing with the current map bounds.
              myHouseLayer.eachLayer(function(marker) {
                  if (bounds.contains(marker.getLatLng())) {
                      inBounds.push(marker.options.title);
                  }
              });
              // Display a list of markers in a scrollable panel.
              // document.getElementById('coordinates').innerHTML = inBounds.join('\n');
          });
var homePopupContent = '<a target="_blank" class="popup" href="' + feature.properties.url + '">' + feature.properties.price + '</a>';

marker.bindPopup(homePopupContent, {
  closeButton: false,
  minWidth:320

});
});


// Filter homes by price using a slider
// function showHomes(minPrice, maxPrice) {
//     $('#myHouseLayer').hide().filter(function() {
//         var price = parseInt($(this).data("price"), 10);
//         return price >= minPrice && price <= maxPrice;
//     }).show();
// }

// $(function() {
//     var options = {
//         range: true,
//         min: 0,
//         max: 1000000,
//         values: [50, 300],
//         slide: function(event, ui) {
//             var min = ui.values[0],
//                 max = ui.values[1];

//             $("#amount").val("$" + min + " - $" + max);
//             showHomes(min, max);
//         }
//     }, min, max;

//     $("#slider-range").slider(options);

//     min = $("#slider-range").slider("values", 0);
//     max = $("#slider-range").slider("values", 1);

//     $("#amount").val("$" + min + " - $" + max);

//     showHomes(min, max);
// })
</script>
</div>
	<div class="col-md-3">


		<form id="Yelp_Params">
			  <h5> I want to live within walking distance of: </h5>
				<label> <input type="checkbox" name="category_filter" value="grocery"> Grocery Stores </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="gyms"> Gym </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="restaurants"> Restaurants </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="divebars"> Dive Bars </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="gaybars"> Gay Bars </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="meditationcenters"> Meditation Centers </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="yoga"> Yoga </label>
				<br>
				<label><input type="checkbox" name="category_filter" value="rock_climbing"> Rock Climbing </label>
				<br>
        <input type="hidden" name="location" value="{{city}}">
				<button id="submit_prefs"> Display</button>
			</form>
		</div>
	</div>
</div>

<script>
// Create query, query Yelp API, return response to create the feature layer and feature collection for Yelp businesses.  AJAX call.
var yelpLayer1 = L.mapbox.featureLayer().addTo(map)
$('#submit_prefs').bind('click', getData)

function getData(e){
  e.preventDefault();
  var url = '/yelp_params'
  var data = $('#Yelp_Params').serializeArray();
  $.get(url, data, function(result){
      var features = [];
          for (var i = 0; i < result.businesses.length; i++) {
              var lat = result.businesses[i].location.coordinate.latitude;
              var lon = result.businesses[i].location.coordinate.longitude; 
              var category5 = result.businesses[i].categories[0]
              console.log(category5)
              features.push({
                  type: 'Feature',
                  geometry: {
                      type: 'Point',
                      coordinates: [lon, lat]
                  },
                  properties: {
                      'marker-color': '#f01',
                      'marker-symbol': 'star-stroked',  //marker symbol variable will be 'star stroked '
                      title: result.businesses[i].name,
                      url: result.businesses[i].url,
                      rating: result.businesses[i].rating
                  }
              });
          }

          yelpLayer1.setGeoJSON({
              type: 'FeatureCollection',
              features: features
          });
      });
}
var yelpLayer1 = L.mapbox.featureLayer().addTo(map)


</script>
<script>

// };



// var map = L.mapbox.map('map', 'sarahfo.ma312pld').setView((setView), 12);
// var myLayer = L.mapbox.featureLayer().addTo(map);

</script>


{% endblock %}